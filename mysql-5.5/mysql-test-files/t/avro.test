use test;
CREATE TABLE `EmailTest` (
  `mboxid` int(11) NOT NULL,
  `docid` int(11) NOT NULL,
  `timestamp` bigint(20) NOT NULL,
  `etag` varchar(10) NOT NULL,
  `val` blob,
  `schema_version` smallint(6) NOT NULL,
  PRIMARY KEY (`mboxid`,`docid`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;


INSERT INTO `EmailTest` VALUES (1,5,1320951678306,'3075464458',0x04041A4D7973716C20697320636F6F6C2E5468697320697320612073686F7274206D657373616765,1),(101,1,1320959967078,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(101,2,1320959967078,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(101,3,1320959967079,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(101,4,1320959967079,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(101,5,1320959967080,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(102,1,1320961913576,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(102,2,1320961913576,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(102,3,1320961913577,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(102,4,1320961913577,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1),(102,5,1320961913578,'2320202066',0xC80102266C7563656E65206C696E6B6564696E20616263245465737420656D61696C2069732074686973,1);

set @schema_def:='{
  "name" : "Email",
  "version": 1,
  "doc" : "Espresso Schema for a simple Email Table",
  "type" : "record",
  "schemaType" : "DocumentSchema",
  "namespace" : "com.linkedin.espresso.test.espressodb",
  "fields" : [ 
  {
    "name" : "createdDate",
    "type" : "long",
     "default" : 0
  }, {
    "name" : "fromMemberId",
    "type" : "long"
  }, {
    "name" : "subject",
    "type" : "string",
    "indexType" : "text"
  }, {
    "name" : "body",
    "type" : "string",
    "indexType" : "attribute"
  } ]
}
';

create table mysql.avro_schema_defs (name varchar(30) not null primary key, def blob not null) engine=myisam;
select avro_register_schema("schema1", @schema_def);
select * from mysql.avro_schema_defs ;
set @schema:="schema1";
select mboxid, docid, length(val), md5(val), avro_fetch(@schema, val, "createdDate"), avro_fetch(@schema, val, "fromMemberId"), avro_fetch(@schema, val, "subject"), avro_fetch(@schema, val, "body") from EmailTest;
--source include/restart_mysqld.inc

select * from mysql.avro_schema_defs ;
set @schema:="schema1";

select mboxid, docid, length(val), md5(val), avro_fetch(@schema, val, "createdDate"), avro_fetch(@schema, val, "fromMemberId"), avro_fetch(@schema, val, "subject"), avro_fetch(@schema, val, "body") from EmailTest;

CREATE TABLE `EmailMetadata` (
  `mboxId` int(11) NOT NULL,
  `emailId` int(11) NOT NULL,
  `timestamp` bigint(20) NOT NULL,
  `etag` varchar(10) NOT NULL,
  `val` blob,
  `schema_version` smallint(6) NOT NULL,
  PRIMARY KEY (`mboxId`,`emailId`)
) ENGINE=InnoDB ;


INSERT INTO `EmailMetadata` VALUES (900000,0,1318886555182,'1667297724',0x086E756C6CEE0200247368696E4066756A6973616E2E636F2E6A70084A4F4246084A4F42460C3330303430314835663165626638652D323333392D346666652D613630332D3462623736323061303665360850454E4402084355525202086E756C6C02086E756C6C020001000000000000000000000000024862646439363236612D306363662D343035612D386632392D38383533663565656138353402086E756C6C26323030372D30342D30385430303A30323A3236DE1540313339312F4A6F696368692049746F2F6A69746F406E656F74656E792E636F6D48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A70028002496620796F7520686176652061206D6F6D656E742C20492764206170707265636961746520796F75722068656C702E20506C656173652074616B652061206C6F6F6B20616E6420666F72776172642074686973206A6F62206F6E20746F20616E796F6E6520796F75207468696E6B20776F756C6420626520696E7465726573744E43616E20796F75207265636F6D6D656E6420736F6D656F6E6520666F722074686973206A6F623F02086E756C6C02086E756C6C02086E756C6C,1),(900000,1,1318886555194,'2259893681',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353935086E756C6C084E4F414302084558505202086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3433A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A70442F4E414B414A494D41204B6569676F2F6E616B616A696D61406B6569676F2E6F72670280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,2,1318886555206,'1007567195',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353936086E756C6C084E4F414302084558505202086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3434A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A705E2F4B6F62617961736869204B617A7574616B612E2F6B617A7574616B612E6B6F62617961736869406E74742E636F6D0280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,3,1318886555215,'2626275380',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34363030086E756C6C084E4F414302084143505402086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3435A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A7054343133303839352F436865756E67204A61737065722F6A636865756E6740616D617A6F6E2E636F2E6A700280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,4,1318886555224,'1063226064',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353939086E756C6C084E4F414302084143505402086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3435A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A70402F4B696E677362757279204A696D2F6865796A696D6B407961686F6F2E636F6D0280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,5,1318886555232,'1131879318',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353734086E756C6C084E4F414302084558505202086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3337A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A70362F4F7A61776120542F746F7A61726E40686F746D61696C2E636F6D0280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,6,1318886555241,'684035274',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353934086E756C6C084E4F414302084558505202086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3432A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A704C2F59616E6F204B696B756B6F2F6B696B756B6F407465616D2E63616665676C6F62652E636F6D0280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,7,1318886555249,'944129864',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353733086E756C6C084E4F414302084558505202086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3337A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A704A2F4D697A75686F2046757275686174612F6D69655F6675727540686F746D61696C2E636F6D0280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1),(900000,8,1318886555257,'1565979705',0x086E756C6C0201086E756C6C08494E564D08494E56541A313830382F3338363231373934086E756C6C084E4F414302084143505402086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030362D30332D33305430373A31333A3232A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A704E353338373036362F5368696E204E697368696E6F2F7368696E794061612E756E6F2E6E652E6A7002086E756C6C364A6F696E206D79206E6574776F726B206F6E204C696E6B6564496E02086E756C6C02086E756C6C02086E756C6C,1),(900000,9,1318886555265,'1096681870',0x086E756C6C0201086E756C6C08494E564D08494E565412313830382F34353932086E756C6C084E4F414302084558505202086E756C6C02086E756C6C02000000000000000000000000000002086E756C6C02086E756C6C26323030332D30352D30385431313A30323A3432A01C48313830382F7368696E206E697368696E6F2F7368696E4066756A6973616E2E636F2E6A70422F53636F7474204D65726C696E6F2F6D65726C696E6F40616D617A6F6E2E636F6D0280024A75737420666F756E642061206E657720736572766963652077686963682072656D696E6473206D65206F6620536978446567726565732E636F6D2E2020536F2049206A7573742077616E74656420746F2073656E64207468697320746F20796F7520746F2074727920746869732E2020436F6D6520636865636B206F7574201E4A6F696E206D79206E6574776F726B02086E756C6C02086E756C6C02086E756C6C,1);
select avro_register_schema("EmailDetail", '{
  "name" : "EmailDetail",
  "doc" : "Document schema for email body, etc",
  "version": 1,
  "type" : "record",
  "schemaType" : "DocumentSchema",
  "namespace" : "com.linkedin.comm.ds.api.espresso",
  "fields" : [
    {"name":"subject", "type":"string", "indexType":"text"},
    {"name":"body", "type":"string", "indexType":"text"},
    {"name":"bodyType", "type":"string"}
  ]
}
');

select avro_register_schema("EmailMetadata",'{
  "name" : "EmailMetadata",
  "doc" : "Document schema for email metadata",
  "version": 1,
  "type" : "record",
  "schemaType" : "DocumentSchema",
  "namespace" : "com.linkedin.comm.ds.api.espresso",
  "fields" : [
    {"name":"fromEmail", "type":"string", "indexType":"attribute"},
    {"name":"toFieldCount", "type":"int"},
    {"name":"recipientsShown", "type":"boolean"},
    {"name":"deliveryEmail", "type":"string"},
    {"name":"messageType", "type":"string", "indexType":"attribute"},
    {"name":"contentType", "type":"string", "indexType":"attribute"},
    {"name":"contentId", "type":"string", "indexType":"attribute"},
    {"name":"cancelKey", "type":"string", "indexType":"attribute"},
    {"name":"actionStatus", "type":"string", "indexType":"attribute"},
    {"name":"contentStatus", "type":["null", "string"] , "default":"null"},
    {"name":"deliveryDirective", "type":["null", "string"] , "default":"null", "indexType":"attribute"},
    {"name":"actionType", "type":["null", "string"] , "default":"null", "indexType":"attribute"},
    {"name":"fromContractId", "type":["null","int"] , "default":"null", "indexType":"attribute"},
    {"name":"isInbox", "type":"boolean", "indexType":"attribute"},
    {"name":"isStarred", "type":"boolean", "indexType":"attribute"},
    {"name":"isActioned", "type":"boolean", "indexType":"attribute"},
    {"name":"isBounced", "type":"boolean"},
    {"name":"isForwarded", "type":"boolean"},
    {"name":"isReplied", "type":"boolean"},
    {"name":"isUnread", "type":"boolean", "indexType":"attribute"},
    {"name":"isArchived", "type":"boolean", "indexType":"attribute"},
    {"name":"isReplyMsg", "type":"boolean", "indexType":"attribute"},
    {"name":"isCancelled", "type":"boolean", "indexType":"attribute"},
    {"name":"isSuspended", "type":"boolean", "indexType":"attribute"},
    {"name":"isWithdrawn", "type":"boolean", "indexType":"attribute"},
    {"name":"isBlocked", "type":"boolean", "indexType":"attribute"},
    {"name":"bounceKey", "type":["null","string"], "default":"null", "indexType":"attribute"},
    {"name":"batchKey", "type":["null","string"], "default":"null", "indexType":"attribute"},
    {"name":"createdOn", "type":"string", "indexType":"attribute"},
    {"name":"fromMemberID", "type":"int", "indexType":"attribute"},
    {"name":"fromField", "type":"string"},
    {"name":"toField", "type":"string"},
    {"name":"shortBody", "type":["null", "string"], "default":"null"},
    {"name":"subject", "type":"string"},
    {"name":"payload", "type":["null", "string"] , "default":"null"},
    {"name":"deletedState", "type":["null", "string"] , "default":"null", "indexType":"attribute"},
    {"name":"legacyId", "type":["null", "string"] , "indexType":"attribute"}
  ]
}
');

let fields = avro_fetch("EmailMetadata", val, "subject"),
  avro_fetch("EmailMetadata", val, "shortBody"),
  avro_fetch("EmailMetadata", val, "createdOn"),
  avro_fetch("EmailMetadata", val, "isInbox"),
  avro_fetch("EmailMetadata", val, "isArchived"),
  avro_fetch("EmailMetadata", val, "fromContractId"),
  avro_fetch("EmailMetadata", val, "fromMemberID"),
  avro_fetch("EmailMetadata", val, "legacyId"),
  avro_fetch("EmailMetadata", val, "recipientsShown"),
  avro_fetch("EmailMetadata", val, "fieldIsNotThere");

--vertical_results
eval select $fields,length(@val:=val) 
 from EmailMetadata  ;

eval select   avro_fetch("EmailMetadata", @val, "shortBody"),
  avro_fetch("EmailMetadata", @val, "createdOn");


eval select $fields
 from EmailMetadata  where avro_match("EmailMetadata", val, 
   "subject='Join my network' && 
   (createdOn >='2003-05-08T11:02:45' || createdOn
       <'2003-05-08T11:02:40')  ");

eval select $fields
 from EmailMetadata  where avro_match("EmailMetadata", val, 
   "subject='Join my network' && 
   !(createdOn >='2003-05-08T11:02:45' || createdOn
       <'2003-05-08T11:02:40')  ");
eval select $fields
 from EmailMetadata  where avro_match("EmailMetadata", val, 
   "subject!='Join my network' ");

eval select $fields
 from EmailMetadata  where avro_match("EmailMetadata", val, 
   "isInbox=1 ");
eval select $fields
 from EmailMetadata  where avro_match("EmailMetadata", val, 
   "isInbox ");

flush tables;
update EmailMetadata set val = avro_update("EmailMetadata", val, 
    '{"shortBody":" new short body ","toFieldCount":3,
      "fromMemberID":"+1","isInbox":false}, 
      "subject" : "I like to put things in \\"quotes\\" and 
      compose poems about newlines \\n and backslashes \\\\" ');

eval select $fields from EmailMetadata  limit 10;

drop table EmailTest,EmailMetadata;
drop table mysql.avro_schema_defs; 
