--exec $MYSQL_TEST_DIR/suite/rpl_dbus/scripts/start-dbus-java.sh
source include/master-slave.inc;
connection slave; 
set global rpl_dbus_debug=1; 
connection master;
let $NUM_DBS=5;
let $PART_PREFIX=38;
let $i=$NUM_DBS;
flush logs;
set sql_log_bin=0;

while ($i)
{
  eval create database es_emailtest_$PART_PREFIX$i;
  eval create database emailtest_$PART_PREFIX$i;
  eval use es_emailtest_$PART_PREFIX$i;
  create table t1(`key` bigint not null primary key, 
   value blob not null) engine=innodb;
  create table t2(id1 bigint not null, 
   id2 mediumint not null, id3 int not null,
   id4 smallint not null, id5 tinyint unsigned not null,
   value blob not null, primary key(id1,id2,id3,id4,id5)) engine=innodb;
  CREATE TABLE `EmailTest` (
  `mboxid` int(11) NOT NULL,
  `docid` int(11) NOT NULL,
  `timestamp` bigint(20) NOT NULL,
  `etag` varchar(10) NOT NULL,
  `val` blob,
  `schema_version` smallint(6) NOT NULL,
  PRIMARY KEY (`mboxid`,`docid`)
) ENGINE=INNODB;
  eval use emailtest_$PART_PREFIX$i;
  create table t1(`key` bigint not null primary key, 
   value blob not null) engine=innodb;
  create table t2(id1 bigint not null, 
   id2 mediumint not null, id3 int not null,
   id4 smallint not null, id5 tinyint unsigned not null,
   value blob not null, primary key(id1,id2,id3,id4,id5)) engine=innodb;
  CREATE TABLE `EmailTest` (
  `mboxid` int(11) NOT NULL,
  `docid` int(11) NOT NULL,
  `timestamp` bigint(20) NOT NULL,
  `etag` varchar(10) NOT NULL,
  `val` blob,
  `schema_version` smallint(6) NOT NULL,
  PRIMARY KEY (`mboxid`,`docid`)
) ENGINE=INNODB;

dec $i;
}

flush logs;
  
create database d1;
create table d1.t1(n int not null primary key) engine=innodb;  
set sql_log_bin=1;
insert into d1.t1 values(3);
flush logs;  
sync_slave_with_master;
connection slave; 

use mysql;
create table rpl_dbus_config(prop_key varchar(128) not null 
  primary key, value varchar(50) not null) engine=myisam;
insert into rpl_dbus_config values ('databus2.mysql.host','cbotev-ld.linkedin.biz'),
  ('databus2.mysql.port','11141');
use test;  
connection master;
let $i = $NUM_DBS;
while ($i)
{
  eval use es_emailtest_$PART_PREFIX$i;
  insert into t1 values (1,'one'),(2,'two'),(3,'three');
  insert into t1 values (4,'four'),(5,'five'),(6,'six');
  update t1 set value='new five' where `key` = 5;
  delete from t1 where `key` = 2;
  update t1 set value='new one' where `key` = 1;
  update t1 set value='new two' where `key` = 2;
  update t1 set value='new three' where `key` = 3;

  insert into t2 values (1,11,111,1111,253,'one');
  insert into EmailTest values (10,100, 1000, 'one', 'One one', 1);
  insert into EmailTest values (20,200, 2000, 'two', 'Two two', 2);
  insert into EmailTest values (30,300, 3000, 'three', 'Three three', 3);
  update EmailTest set val = 'New one' where mboxid = 10 and docid = 100;
  update EmailTest set val = 'New two' where mboxid = 20 and docid = 200;
  delete from EmailTest where mboxid = 30 and docid = 300;
  eval use emailtest_$PART_PREFIX$i;
  insert into t1 values (1,'one short'),(2,'two short'),(3,'three short');
  insert into t1 values (4,'four s'),(5,'five s'),(6,'six s');
  update t1 set value='new five s' where `key` = 5;
  delete from t1 where `key` = 2;
  update t1 set value='new one s' where `key` = 1;
  update t1 set value='new two s' where `key` = 2;
  update t1 set value='new three s' where `key` = 3;
  dec $i;
}
sync_slave_with_master;
connection slave;
let $n=2;
eval show create table es_emailtest_$PART_PREFIX$n.t1;
eval show create table es_emailtest_$PART_PREFIX$n.t2;
show create table d1.t1;
connection master;

let $i=$NUM_DBS;

while ($i)
{
  eval drop database es_emailtest_$PART_PREFIX$i;
  eval drop database emailtest_$PART_PREFIX$i;
  dec $i;
}

drop database d1; 
sync_slave_with_master;
connection slave;
stop slave;
set global rpl_dbus_debug = 0;
#drop table mysql.rpl_dbus_config;
--exec curl -s "http://localhost:8887/stream?sources=1,2&output=JSON&size=100000" |sed -r s/\"timestampInNanos\"\:[0-9]+// 
--exec curl -s "http://localhost:8887/stream?sources=3&output=JSON&size=100000" 
--exec $MYSQL_TEST_DIR/suite/rpl_dbus/scripts/stop-dbus-java.sh
