#!/bin/bash
#******************************************************
# set TEST_NAME before calling setup_env.inc
#******************************************************
# test bizfollow db relay can run with a small buffer.
export TEST_NAME=espresso_long_running.test
#******************************************************
# sets up common environmnet variables and 
source setup_env.inc

#***************************************************************************************************************************************
#all ${ALL_CAPS} type vars come from setup_env.inc(except TEST_NAME)...check that file first before introducing any new variables here
#***************************************************************************************************************************************
relay_port=${RELAY_PORT_BASE}
client_port=${CLIENT_PORT_BASE}
let client_port_2="${CLIENT_PORT_BASE}+100"
relay_event_trace=${WORK_DIR_FROM_ROOT}/espresso_relay_event_trace
relay_event_trace_1=${WORK_DIR_FROM_ROOT}/espresso_relay_event_trace_1
relay_event_trace_2=${WORK_DIR_FROM_ROOT}/espresso_relay_event_trace_2
consumer_1_log=${WORK_DIR_FROM_ROOT}/espresso_consumer_1.events
consumer_1_value_log=${WORK_DIR_FROM_ROOT}/espresso_consumer_1.values
consumer_1_cp_dir=${WORK_DIR_FROM_ROOT}/ckpt/1
consumer_1_cp_dir_from_root=${VIEW_ROOT}/${WORK_DIR_FROM_ROOT}/ckpt/1
consumer_2_log=${WORK_DIR_FROM_ROOT}/espresso_consumer_2.events
consumer_2_value_log=${WORK_DIR_FROM_ROOT}/espresso_consumer_2.values
consumer_2_cp_dir=${WORK_DIR_FROM_ROOT}/ckpt/2
consumer_2_cp_dir_from_root=${VIEW_ROOT}/${WORK_DIR_FROM_ROOT}/ckpt/2
espresso_conf_dir=${CONFIG_DIR}/espresso
espresso_config_file1=${espresso_conf_dir}/json/ppart__es_EspressoDB
espresso_config_file2=${espresso_conf_dir}/json/ppart__es_EspressoDB16
espresso_config_files=${espresso_config_file1},${espresso_config_file2}
espressoDB_list=EspressoDB,EspressoDB16
espressoDB_partitions=1,16
espresso_sources_1=EspressoDB.*:0
espresso_sources_16=EspressoDB16.*:0,EspressoDB16.*:1,EspressoDB16.*:2,EspressoDB16.*:3,EspressoDB16.*:4,EspressoDB16.*:5,EspressoDB16.*:6,EspressoDB16.*:7,EspressoDB16.*:8,EspressoDB16.*:9,EspressoDB16.*:10,EspressoDB16.*:11,EspressoDB16.*:12,EspressoDB16.*:13,EspressoDB16.*:14,EspressoDB16.*:15
data_root=${VIEW_ROOT}/integration-test/data/testcases/espresso

jvm_direct_memory="-XX:MaxDirectMemorySize=2g"
jvm_min_heap="-Xms100m"
jvm_max_heap="-Xmx1g"
jvm_gc_args="-XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:-CMSParallelRemarkEnabled -XX:MaxTenuringThreshold=1 -XX:SurvivorRatio=3 -XX:CMSInitiatingOccupancyFraction=85 -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintTenuringDistribution"
jvm_args="${jvm_direct_memory} ${jvm_min_heap} ${jvm_max_heap} ${jvm_new_size} ${jvm_gc_args}"



$SCRIPT_DIR/dbus2_driver.py -n $TEST_NAME -c espresso_storage_node -o stop
