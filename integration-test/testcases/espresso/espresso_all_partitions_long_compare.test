#!/bin/bash
#******************************************************
# set TEST_NAME before calling setup_env.inc
#******************************************************
# test bizfollow db relay can run with a small buffer.
export TEST_NAME=espresso_all_partitions_client.test
#******************************************************
# sets up common environmnet variables and 
source setup_env.inc
#***************************************************************************************************************************************
#all ${ALL_CAPS} type vars come from setup_env.inc(except TEST_NAME)...check that file first before introducing any new variables here
#***************************************************************************************************************************************
relay_host=esv4-bed03.corp.linkedin.com
relay_port=${RELAY_PORT_BASE}
client_port=${CLIENT_PORT_BASE}
relay_event_trace=${WORK_DIR_FROM_ROOT}/espresso_relay_event_trace
consumer_event_log_base=${WORK_DIR_FROM_ROOT}/espresso_consumer_events
consumer_value_log_base=${WORK_DIR_FROM_ROOT}/espresso_consumer_values
consumer_cp_dir_base=${WORK_DIR_FROM_ROOT}/ckpt
consumer_cp_dir_from_root_base=${VIEW_ROOT}/${WORK_DIR_FROM_ROOT}/ckpt
espresso_conf_dir=${CONFIG_DIR}/espresso
espressoDB_list=EspressoDB,TestDB,EspressoDB2,EspressoDB4,EspressoDB8,EspressoDB10,EspressoDB16,EspressoDB24,EspressoDB32
espresso_config_file1=${espresso_conf_dir}/json/ppart__es_EspressoDB
espresso_config_file2=${espresso_conf_dir}/json/ppart__es_TestDB
espresso_config_file3=${espresso_conf_dir}/json/ppart__es_EspressoDB2
espresso_config_file4=${espresso_conf_dir}/json/ppart__es_EspressoDB4
espresso_config_file5=${espresso_conf_dir}/json/ppart__es_EspressoDB8
espresso_config_file6=${espresso_conf_dir}/json/ppart__es_EspressoDB10
espresso_config_file7=${espresso_conf_dir}/json/ppart__es_EspressoDB16
espresso_config_file8=${espresso_conf_dir}/json/ppart__es_EspressoDB24
espresso_config_file9=${espresso_conf_dir}/json/ppart__es_EspressoDB32
espressoDB_partitions=1,1,2,4,8,10,16,24,32
espresso_sources_1=EspressoDB.*:0
espresso_sources_2=EspressoDB2.*:0,EspressoDB2.*:1
espresso_sources_3=EspressoDB4.*:0,EspressoDB4.*:1,EspressoDB4.*:2,EspressoDB4.*:3
espresso_sources_4=EspressoDB8.*:0,EspressoDB8.*:1,EspressoDB8.*:2,EspressoDB8.*:3,EspressoDB8.*:4,EspressoDB8.*:5,EspressoDB8.*:6,EspressoDB8.*:7
espresso_sources_5=EspressoDB10.*:0,EspressoDB10.*:1,EspressoDB10.*:2,EspressoDB10.*:3,EspressoDB10.*:4,EspressoDB10.*:5,EspressoDB10.*:6,EspressoDB10.*:7,EspressoDB10.*:8,EspressoDB10.*:9
espresso_sources_6=EspressoDB16.*:0,EspressoDB16.*:1,EspressoDB16.*:2,EspressoDB16.*:3,EspressoDB16.*:4,EspressoDB16.*:5,EspressoDB16.*:6,EspressoDB16.*:7,EspressoDB16.*:8,EspressoDB16.*:9,EspressoDB16.*:10,EspressoDB16.*:11,EspressoDB16.*:12,EspressoDB16.*:13,EspressoDB16.*:14,EspressoDB16.*:15
espresso_sources_7=EspressoDB24.*:0,EspressoDB24.*:1,EspressoDB24.*:2,EspressoDB24.*:3,EspressoDB24.*:4,EspressoDB24.*:5,EspressoDB24.*:6,EspressoDB24.*:7,EspressoDB24.*:8,EspressoDB24.*:9,EspressoDB24.*:10,EspressoDB24.*:11,EspressoDB24.*:12,EspressoDB24.*:13,EspressoDB24.*:14,EspressoDB24.*:15,EspressoDB24.*:16,EspressoDB24.*:17,EspressoDB24.*:18,EspressoDB24.*:19,EspressoDB24.*:20,EspressoDB24.*:21,EspressoDB24.*:22,EspressoDB24.*:23
espresso_sources_8=EspressoDB32.*:0,EspressoDB32.*:1,EspressoDB32.*:2,EspressoDB32.*:3,EspressoDB32.*:4,EspressoDB32.*:5,EspressoDB32.*:6,EspressoDB32.*:7,EspressoDB32.*:8,EspressoDB32.*:9,EspressoDB32.*:10,EspressoDB32.*:11,EspressoDB32.*:12,EspressoDB32.*:13,EspressoDB32.*:14,EspressoDB32.*:15,EspressoDB32.*:16,EspressoDB32.*:17,EspressoDB32.*:18,EspressoDB32.*:19,EspressoDB32.*:20,EspressoDB32.*:21,EspressoDB32.*:22,EspressoDB32.*:23,EspressoDB32.*:24,EspressoDB32.*:25,EspressoDB32.*:26,EspressoDB32.*:27,EspressoDB32.*:28,EspressoDB32.*:29,EspressoDB32.*:30,EspressoDB32.*:31
espresso_config_files=${espresso_config_file1},${espresso_config_file2},${espresso_config_file3},${espresso_config_file4},${espresso_config_file5},${espresso_config_file6},${espresso_config_file7},${espresso_config_file8},${espresso_config_file9}
data_root=${VIEW_ROOT}/integration-test/data/testcases/espresso
data_file=${data_root}/EspressoDB_1.dat
jvm_direct_memory="-XX:MaxDirectMemorySize=500m"
jvm_min_heap="-Xms1g"
jvm_max_heap="-Xmx1g"
jvm_new_size="-XX:NewSize=512m -XX:MaxNewSize=512m"
jvm_gc_args="-XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:-CMSParallelRemarkEnabled -XX:MaxTenuringThreshold=1 -XX:SurvivorRatio=3 -XX:CMSInitiatingOccupancyFraction=85 -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintTenuringDistribution"
jvm_args="${jvm_direct_memory} ${jvm_min_heap} ${jvm_max_heap} ${jvm_new_size} ${jvm_gc_args}"


for i in {1..8}
do
    if [ ! -d ${consumer_cp_dir_from_root_base}/$i ]; then
        mkdir -p ${consumer_cp_dir_from_root_base/$i}
    fi 
done
#create the checkpoint folders


#for i in {1..8}
#do
#    consumer_value_log="${consumer_value_log_base}_${i}"
#    consumer_log="${consumer_event_log_base}_${i}"
#    consumer_cp_dir="${consumer_cp_dir_base}/${i}"
#    let client_port="${client_port}+100"
#    espresso_sources_name=espresso_sources_$i
#    espresso_sources="${!espresso_sources_name}"
#$SCRIPT_DIR/dbus2_driver.py -n $TEST_NAME -c espresso_client -o start --value_file=${consumer_value_log} --cmdline_props="databus.espresso.client.checkpointPersistence.fileSystem.rootDirectory=${consumer_cp_dir};databus.espresso.client.checkpointPersistence.clearBeforeUse=true;databus.espresso.client.connectionDefaults.eventBuffer.trace.filename=${consumer_log};databus.espresso.client.container.httpPort=${client_port};databus.espresso.client.runtime.relay(1).sources=${espresso_sources}" -p ${espresso_conf_dir}/espresso_client.properties -l ${espresso_conf_dir}/espresso_client_log4j.properties --jvm_args="${jvm_args}"
#done

#$SCRIPT_DIR/dbus2_driver.py -c espresso_client -o wait_event --relay_port=${relay_port} --http_port=${client_port} --db_list=${espressoDB_list} --db_range=${espressoDB_partitions} --client_base_port_list=${client_port_list} 

#sleep 300
#$SCRIPT_DIR/dbus2_driver.py -n $TEST_NAME -c espresso_client -o stop
#$SCRIPT_DIR/dbus2_driver.py -n $TEST_NAME -c espresso_relay -o stop
#$SCRIPT_DIR/dbus2_driver.py -n $TEST_NAME -c espresso_storage_node -o stop
#echo == Looking for Error,ERROR or Exception in log files
#ls -1tr $LOG_DIR/esp* | xargs grep ERROR
#ls -1tr $LOG_DIR/esp* | xargs grep Error
#ls -1tr $LOG_DIR/esp* | xargs grep -i Exception

$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_1 --db_list=EspressoDB --db_range=1
source report_pass_fail.inc
$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_2 --db_list=EspressoDB2 --db_range=2
source report_pass_fail.inc
$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_3 --db_list=EspressoDB4 --db_range=4
source report_pass_fail.inc
$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_4 --db_list=EspressoDB8 --db_range=8
source report_pass_fail.inc
$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_5 --db_list=EspressoDB10 --db_range=10
source report_pass_fail.inc
$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_6 --db_list=EspressoDB16 --db_range=16
source report_pass_fail.inc
$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_event_log_base}_7 --db_list=EspressoDB24 --db_range=24
source report_pass_fail.inc
final_report=1
#$SCRIPT_DIR/dbus2_json_compare.py --espresso_compare --file1=${relay_event_trace} --file2=${consumer_1_log} --db_list=EspressoDB32 --db_range=32
source report_pass_fail.inc
echo Number of failures = $all_stat
exit $all_stat
