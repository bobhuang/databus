#!/bin/bash
# simple liar generation test

export TEST_NAME=liar_fault_injection.test
source setup_env.inc

relay_event_dump_file=integration-test/var/work/${TEST_NAME}/liar_relay_event_trace
relay_gc_file=integration-test/var/work/${TEST_NAME}/liar_relay_gc.log
db_config_file=${CONFIG_DIR_FROM_ROOT}/sources-liar.json
relay_event_dump_file=${WORK_DIR_FROM_ROOT}/liar_relay_event_trace

#start the relay
$SCRIPT_DIR/dbus2_driver.py -c liar_relay -o start --jvm_args="-Xms24m -Xmx500m -agentlib:jdwp=transport=dt_socket,suspend=n,address=localhost:8999,server=y " --jvm_gc_log=${relay_gc_file} --cmdline_props="databus.relay.eventBuffer.maxSize=10240000;databus.relay.eventBuffer.trace.option=file;databus.relay.eventBuffer.trace.filename=${relay_event_dump_file};databus.relay.eventBuffer.trace.appendOnly=false"

$SCRIPT_DIR/dbus2_gen_event.py -e 150 -s 20,21 -t 7200 

#idle for 2 mins..let relay fill up a little bit
#sleep 120 

# reset the db and delete the checkpoints
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_dbreset

# start the producer, use a given port to avoid conflict with consumer
$SCRIPT_DIR/dbus2_driver.py -c test_bootstrap_producer -o start --cmdline_props="databus.bootstrap.client.runtime.relay(1).sources=com.linkedin.events.liar.jobrelay.LiarJobRelay,com.linkedin.events.liar.memberrelay.LiarMemberRelay;databus.bootstrap.client.container.httpPort=6061;databus.bootstrap.client.checkpointPersistence.fileSystem.rootDirectory=./bootstrap-checkpoints;databus.bootstrap.client.checkpointPersistence.clearBeforeUse=true;databus.bootstrap.client.connectionDefaults.eventBuffer.maxSize=10240000;databus.bootstrap.client.connectionDefaults.eventBuffer.allocationPolicy=DIRECT_MEMORY;databus.bootstrap.client.connectionDefaults.eventBuffer.queuePolicy=BLOCK_ON_WRITE;databus.bootstrap.client.connectionDefaults.eventBuffer.readBufferSize=1024000;databus.bootstrap.client.connectionDefaults.eventBuffer.scnIndexSize=1024000;databus.bootstrap.client.runtime.relay(1).host=localhost;databus.bootstrap.client.runtime.relay(1).port=8080"

# start the bootstrap server on port 6060
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_server -o start

#idle for 10 mins...wait for bootstrap to get some events
#sleep 600
# start the consumer
consumer_1_log=${WORK_DIR_FROM_ROOT}/liar_consumer_1.events
consumer_2_log=${WORK_DIR_FROM_ROOT}/liar_consumer_2.events
consumer_3_log=${WORK_DIR_FROM_ROOT}/liar_consumer_3.events

cp_1_dir=integration-test/var/work/${TEST_NAME}/ckpt_1
cp_2_dir=integration-test/var/work/${TEST_NAME}/ckpt_2
cp_3_dir=integration-test/var/work/${TEST_NAME}/ckpt_3

$SCRIPT_DIR/dbus2_driver.py -c liar_consumer -o start --dump_file=${consumer_1_log} --cmdline_props="databus.client.checkpointPersistence.fileSystem.rootDirectory=${cp_1_dir};databus.client.checkpointPersistence.clearBeforeUse=true"

$SCRIPT_DIR/dbus2_driver.py -c liar_consumer -o start --dump_file=${consumer_2_log} --cmdline_props="databus.client.checkpointPersistence.fileSystem.rootDirectory=${cp_2_dir};databus.client.checkpointPersistence.clearBeforeUse=true"

$SCRIPT_DIR/dbus2_driver.py -c liar_consumer -o start --dump_file=${consumer_3_log} --cmdline_props="databus.client.checkpointPersistence.fileSystem.rootDirectory=${cp_3_dir};databus.client.checkpointPersistence.clearBeforeUse=true"

relay_pid=$(jps | grep LiarRelayServer | cut -d ' ' -f 1)
echo $relay_pid
bsp_pid=$(jps | grep DatabusBootstrapProducer | cut -d ' ' -f 1)
echo $bsp_pid
bss_pid=$(jps | grep BootstrapHttpServer | cut -d ' ' -f 1)
echo $bss_pid
liarc1_pid=$(jps | grep SimpleLiarConsumer | cut -d ' ' -f 1 | xargs | cut -d ' ' -f 1)
echo $liarc1_pid
liarc2_pid=$(jps | grep SimpleLiarConsumer | cut -d ' ' -f 1 | xargs | cut -d ' ' -f 2)
echo $liarc2_pid
liarc3_pid=$(jps | grep SimpleLiarConsumer | cut -d ' ' -f 1 | xargs | cut -d ' ' -f 3)
echo $liarc3_pid

#sleep 20
$SCRIPT_DIR/fault_injection_sim.py --pids "${relay_pid} ${bsp_pid} ${bss_pid} ${liarc1_pid} ${liarc2_pid} ${liarc3_pid}"  --time 6000
sleep 100
$SCRIPT_DIR/dbus2_json_compare.py ${relay_event_dump_file} ${consumer_1_log}
$SCRIPT_DIR/dbus2_json_compare.py ${relay_event_dump_file} ${consumer_2_log}
$SCRIPT_DIR/dbus2_json_compare.py ${relay_event_dump_file} ${consumer_3_log}
