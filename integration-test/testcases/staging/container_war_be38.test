# 
# Set up esv4-be machines for CHO bizfollow testing
# need to clean up dist before the test
# esv4-be38  -> relay 9090 bizfollow 9091 liar (not started)
# esv4-be39  -> bootstrap 6060 producer 6161 server
# esv4-be40  -> consumer (7062)
#
#PERFDB =
#(DESCRIPTION =
#    (ADDRESS_LIST =
#      (ADDRESS = (PROTOCOL = TCP)(HOST = perfdb.qa.linkedin.com)(PORT = 1521))
#    )
#    (CONNECT_DATA =
#      (SERVICE_NAME = DB)
#    )
# )
source setup_env.inc
bizfollow_db_config_file=${CONFIG_DIR_FROM_ROOT}/sources-bizfollow.json 
bizfollow_perf_db_config_file=${CONFIG_DIR_FROM_ROOT}/sources-bizfollow-perfdb.json 
liar_db_config_file=${CONFIG_DIR_FROM_ROOT}/sources-liar.json 

consumer_port=7062
# do not change this as the producer depends on it
bizfollow_relay_port=9090
bizfollow_relay_host=esv4-be38
bizfollow_bootstrap_host=esv4-be39

# deploy the wars
#---------
# esv4-be38
#---------
$SCRIPT_DIR/dbus2_driver.py -c relay_container -o start
$SCRIPT_DIR/dbus2_driver.py -c relay_deploy -o start -x "db.bizfollow.db_url;jdbc:oracle:thin:bizfollow/bizfollow@perfdb.qa.linkedin.com:1521:DB"
$SCRIPT_DIR/dbus2_driver.py -c relay_deploy -o start -x "db.bizfollow.db_url;jdbc:oracle:thin:bizfollow/bizfollow@172.16.220.111:1521:DB"
$SCRIPT_DIR/dbus2_driver.py -c relay_deploy -o stop

#$SCRIPT_DIR/dbus2_driver.py -c relay_deploy -o start -x "db.bizfollow.db_url;jdbc:oracle:thin:system/manager@perfdb.qa:1521:DB"
#$SCRIPT_DIR/dbus2_driver.py -c relay_deploy -o start -x "db.bizfollow.db_url;jdbc:oracle:thin:bizfollow/bizfollow8uat2@esv4-db17.stg.linkedin.com:1521:SDRF"

#$SCRIPT_DIR/dbus2_driver.py -c relay_deploy -o start -x "db.bizfollow.db_url;jdbc;oracle;thin;bizfollow/bizfollow@perfdb.qa.linkedin.com;1521;DB" -x "databus2.relay.default;databus.relay.eventBuffer.maxSize;2048000" -x "databus2.relay.local.bizfollow;databus.relay.container.httpPort;${bizfollow_relay_port}" -x "
# start and stop
$SCRIPT_DIR/dbus2_gen_event.py --db_gen -s bizfollow  --db_config_file=${bizfollow_perf_db_config_file} --from_scn=1 --server_port=${bizfollow_relay_port}
$SCRIPT_DIR/dbus2_gen_event.py --db_gen --resume_gen -s bizfollow  --db_config_file=${bizfollow_perf_db_config_file} --from_scn=1 --server_port=${bizfollow_relay_port}
$SCRIPT_DIR/dbus2_gen_event.py --db_gen --suspend_gen -s liar  --db_config_file=${liar_db_config_file} --server_port=${bizfollow_relay_port}

$SCRIPT_DIR/dbus2_gen_event.py -s bizfollow --db_testdata_insert --db_config_file=${bizfollow_perf_db_config_file} --num_events=100
# go to perftest20 to start the generator

#---------
# esv4-be39
#---------
# reset the db and delete the checkpoints
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_dbreset
# grant to all host at the localhost expand as -h does not work
mysql -vvv -u root -Dbootstrap -e "grant all on bootstrap.* to bootstrap@'%' identified by 'bootstrap'; flush privileges;"

$SCRIPT_DIR/dbus2_driver.py -c bootstrap_producer_container -o start
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_producer_deploy -o start -x "databus2.bootstrap.producer.default;databus.bootstrap.producer.client.runtime.relay(1).host;${bizfollow_relay_host}"
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_server_container -o start
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_server_deploy -o start

#---------
# esv4-be40
#---------
$SCRIPT_DIR/dbus2_driver.py -c client_container -o start
$SCRIPT_DIR/dbus2_driver.py -c test_consumer_deploy -o start -x "databus2.test.consumer.default;databus.test.consumer.client.container.httpPort;${consumer_port}" -x "databus2.test.consumer.default;databus.test.consumer.client.runtime.relay(1).host;${bizfollow_relay_host}" -x "databus2.test.consumer.default;databus.test.consumer.client.runtime.bootstrap.service(1).host;${bizfollow_bootstrap_host}"


