#!/bin/bash 
# test liar db relay can run with a small buffer.

source setup_env.inc
# start the relay on port 8080
source setup_env.inc
$SCRIPT_DIR/dbus2_driver.py -c bizfollow_relay -o start --cmdline_props="databus.relay.eventBuffer.maxSize=10240000;databus.relay.eventBuffer.trace.option=file;databus.relay.eventBuffer.trace.filename=integration-test/var/work/bizfollow_relay_event_trace;databus.relay.eventBuffer.trace.appendOnly=false"

# start the consumer
consumer_1_log=${WORK_DIR_FROM_ROOT}/liar_consumer_1.events
consumer_1_value_log=${WORK_DIR_FROM_ROOT}/liar_consumer_1.values
$SCRIPT_DIR/dbus2_driver.py -c liar_consumer -o start --dump_file=${consumer_1_log} --value_file=${consumer_1_value_log} --cmdline_props="databus.client.checkpointPersistence.fileSystem.rootDirectory=./liarclient-checkpoints;databus.client.checkpointPersistence.clearBeforeUse=true;databus.client.connectionDefaults.eventBuffer.maxSize=10240000;databus.client.connectionDefaults.eventBuffer.allocationPolicy=DIRECT_MEMORY;databus.client.connectionDefaults.eventBuffer.queuePolicy=BLOCK_ON_WRITE;databus.client.connectionDefaults.eventBuffer.readBufferSize=1024000;databus.client.connectionDefaults.eventBuffer.scnIndexSize=1024000"

sleep 1

# Are there any errors
echo == Are there any errors?
ls -1tr $LOG_DIR/*liar_consumer_start* | ${TAIL_PATH} -n 1 | xargs ${TAIL_PATH} -n 1
