#!/bin/bash 
# test bizfollow db relay can run with a small buffer.
#******************************************************
# set TEST_NAME before calling setup_env.inc
#******************************************************
export TEST_NAME=start_bizfollow_bootstrap.test_perf
#******************************************************
# sets up common environmnet variables and 
source setup_env.inc

#***************************************************************************************************************************************
#all ${ALL_CAPS} type vars come from setup_env.inc(except TEST_NAME)...check that file first before introducing any new variables here
#***************************************************************************************************************************************
relay_port=${RELAY_PORT_BASE}
relay_host=esv4-be40.corp
#relay_host=localhost
bootstrap_producer_port=${BOOTSTRAP_PRODUCER_PORT_BASE}
bootstrap_server_port=${BOOTSTRAP_SERVER_PORT_BASE}
#bootstrap_host=esv4-bed03
#bootstrap_host=localhost
client_port=${CLIENT_PORT_BASE}
db_config_file=config/sources-bizfollow.json 
bootstrap_gc_file=${WORK_DIR_FROM_ROOT}/bizfollow_bootstrap_gc.log

# reset the db and delete the checkpoints
#$SCRIPT_DIR/dbus2_driver.py -c bootstrap_dbreset

# start the producer, use a given port to avoid conflict with consumer
$SCRIPT_DIR/dbus2_driver.py -c test_bootstrap_producer -o start --jvm_gc_log=${relay_gc_file} --cmdline_props="databus.bootstrap.client.runtime.relay(1).sources=com.linkedin.events.bizfollow.bizfollow.BizFollow;databus.bootstrap.client.container.httpPort=${bootstrap_producer_port};databus.bootstrap.client.checkpointPersistence.fileSystem.rootDirectory=./bootstrap-checkpoints;databus.bootstrap.client.checkpointPersistence.clearBeforeUse=true;databus.bootstrap.client.connectionDefaults.eventBuffer.maxSize=10240000;databus.bootstrap.client.connectionDefaults.eventBuffer.allocationPolicy=DIRECT_MEMORY;databus.bootstrap.client.connectionDefaults.eventBuffer.queuePolicy=BLOCK_ON_WRITE;databus.bootstrap.client.connectionDefaults.eventBuffer.readBufferSize=10240000;databus.bootstrap.client.connectionDefaults.eventBuffer.scnIndexSize=10240000;databus.bootstrap.bootstrapLogSize=1000000;databus.bootstrap.client.runtime.relay(1).host=${relay_host};databus.bootstrap.client.runtime.relay(1).port=${relay_port}"


# start the bootstrap server 
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_server -o start --cmdline_props="databus.bootstrap.db.container.httpPort=${bootstrap_server_port}"


