#!/bin/bash
# test a relay with multiple client can run with a small buffer.
#  -. start member2relay with a property file config/relay-config-small-1.properties
#  -. gen event, monitoring the buffer stats, freespace etc
#  start client before the gen_event

# start the relay on port 8080
source setup_env.inc
#NUM_CONSUMERS=20
RELAY_HOST=esv4-be40
BOOTSTRAP_HOST=esv4-bed03
for NUM_CONSUMERS in 1 4 8 16 32; do
  rm -rf $WORK_DIR/ckpt_*
  #NUM_CONSUMERS=4
  num=1
  while [ "$num" -le $NUM_CONSUMERS ]; do 
    date
    #$SCRIPT_DIR/dbus2_driver.py -c bizfollow_consumer -o start --relay_host=${RELAY_HOST} --bootstrap_host=${BOOTSTRAP_HOST} --bootstrap_port=6060 --checkpoint_dir=integration-test/var/work/ckpt_${num} -l ${CONFIG_DIR_FROM_ROOT}/client-log4j2file.properties.error --cmdline_props="databus.client.connectionDefaults.eventBuffer.maxSize=10240000;databus.client.connectionDefaults.eventBuffer.scnIndexSize=1024000;databus.client.connectionDefaults.eventBuffer.readBufferSize=1024000"
    $SCRIPT_DIR/dbus2_driver.py -c bizfollow_consumer -o start --relay_host=${RELAY_HOST} --bootstrap_host=${BOOTSTRAP_HOST} --bootstrap_port=6060 --checkpoint_dir=integration-test/var/work/ckpt_${num} --cmdline_props="databus.client.connectionDefaults.eventBuffer.maxSize=10240000;databus.client.connectionDefaults.eventBuffer.scnIndexSize=1024000;databus.client.connectionDefaults.eventBuffer.readBufferSize=1024000"
    let "num+=1"
    done     
    sleep 7200
    date
    python -c "import urllib; print urllib.urlopen('http://esv4-be40:8080/containerStats/inbound/events/total').read()"
  # kill all
  ps -ef | grep java | awk '{print $NF}'  | xargs kill -9
  done
done

