#!/bin/bash
# Test bootstrap producer (and thus client) repeated undeployment when producer is configured
# with infinite puller retries

#******************************************************
# set TEST_NAME before calling setup_env.inc
#******************************************************
export TEST_NAME=conn_producer_war_undeploy_inf_retries.test
#******************************************************
# sets up common environmnet variables and 
source setup_env.inc

#***************************************************************************************************************************************
#all ${ALL_CAPS} type vars come from setup_env.inc(except TEST_NAME)...check that file first before introducing any new variables here
#***************************************************************************************************************************************

ITER_NUM=15

echo "#### reset the db and delete the checkpoints"
$SCRIPT_DIR/dbus2_driver.py -c bootstrap_dbreset

for i in `seq 1 $ITER_NUM` ; do
  echo "#### BEGIN ITERATION $i"
  
  echo "#### starting relay" 
  $SCRIPT_DIR/dbus2_driver.py -c conn_relay_deploy -o start 
  
  echo "#### TEST 1 relay deployed successfully"
  assert_with_retry 11 "curl localhost:${CONN_RELAY_PORT}/databus2-relay-conn/admin"
  source report_pass_fail.inc
  
  echo "#### start the producer, use a given port to avoid conflict with consumer"
  $SCRIPT_DIR/dbus2_driver.py -c conn_bst_producer_deploy -o start 
  
  echo "#### TEST 2 bootstrap producer deployed successfully"
  assert_with_retry 11 "curl localhost:${CONN_BOOTSTRAP_PRODUCER_PORT}/databus2-bootstrap-producer-conn/admin"
  source report_pass_fail.inc

  echo "#### wait to start polling "
  sleep 5   

  echo "#### stop relay"  
  $SCRIPT_DIR/dbus2_driver.py -c conn_relay_deploy -o stop
  
  echo "#### TEST 3.1 relay undeployed successfully"
  assert_false_with_retry 11 "curl localhost:${CONN_RELAY_PORT}/databus2-relay-conn/admin"
  source report_pass_fail.inc
  
  echo "#### TEST 3.2 relay container stopped successfully"
  assert_false_with_retry 11 "curl localhost:${CONN_RELAY_CONTAINER_PORT}/jmx"
  source report_pass_fail.inc
  
  echo "#### puller should be in error retry mode"
  sleep 5
  
  echo "##### stop producer"
  $SCRIPT_DIR/dbus2_driver.py -c conn_bst_producer_deploy -o stop

  echo "#### TEST 4.1 bootstrap producer undeployed successfully"
  assert_false_with_retry 11 "curl localhost:${CONN_BOOTSTRAP_PRODUCER_PORT}/databus2-bootstrap-producer-conn/admin"
  source report_pass_fail.inc

  echo "#### TEST 4.2 bootstrap producer container stopped successfully"
  assert_false_with_retry 11 "curl localhost:${CONN_BOOTSTRAP_PRODUCER_CONTAINER_PORT}/jmx"
  source report_pass_fail.inc
done  

exit $all_stat

